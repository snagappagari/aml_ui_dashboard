trigger:
- main

pool:
  name: MySelfHostedPool

variables:
  imageName: 'aml-ui-dashboard'
  acrLoginServer: 'acrall.azurecr.io'

steps:
- checkout: self

- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Install Node.js'

- script: |
    npm install
    npm run build
  displayName: 'npm install and build'

- task: AzureCLI@2
  inputs:
    azureSubscription: 'sc-new'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az acr login --name acrall

- script: |
    docker buildx create --use
    docker buildx build --platform linux/amd64 \
      -t $(acrLoginServer)/$(imageName):$(Build.BuildId) \
      --push .
  displayName: 'Build and Push Docker Image to ACR (linux/amd64)'
  workingDirectory: '$(Build.SourcesDirectory)'

# Add Replace Tokens task before deployment
- task: replacetokens@3
  displayName: 'Replace tokens in deployment.yaml'
  inputs:
    targetFiles: '**/deployment.yaml'
    tokenPrefix: '#{'
    tokenSuffix: '}#'

- task: Kubernetes@1
  displayName: 'Deploy to AKS'
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscriptionEndpoint: 'sc-new'
    azureResourceGroup: 'devops-connection'
    kubernetesCluster: 'aks-all'
    namespace: 'default'
    command: apply
    useConfigurationFile: true
    configuration: 'deployment.yaml'
